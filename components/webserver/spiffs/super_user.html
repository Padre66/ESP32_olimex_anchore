<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Super User – UWB Anchor</title>
<style>
  :root{--bg:#0b1522;--panel:#0e1d2b;--panel2:#0a1825;--muted:#9fb0c7;--txt:#e9f1fb;--acc:#2da8ff;--ok:#19c37d;--warn:#ffb020;--err:#ff5d5d}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#091321,#0b1522);color:var(--txt);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,sans-serif}
  header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;gap:12px;align-items:center}
  h1{margin:0;font-size:16px}
  .wrap{padding:16px;display:grid;gap:14px}
  .grid{display:grid;gap:14px}
  .card{background:color-mix(in srgb,var(--panel) 92%,#000 8%);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 10px 34px rgba(0,0,0,.35)}
  .card .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
  .card .bd{padding:12px}
  .btn{appearance:none;border:0;border-radius:12px;padding:9px 12px;background:linear-gradient(180deg,var(--acc),#57b6ff);color:#00203a;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--txt);border:1px solid rgba(255,255,255,.18)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-top:1px solid rgba(255,255,255,.06)}
  th{color:var(--muted);text-align:left}
  .pill{display:inline-block;padding:2px 7px;border-radius:999px;font-size:11px}
  .ok{background:rgba(25,195,125,.2);color:#9ce7c9}
  .err{background:rgba(255,93,93,.18);color:#ffc3c3}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px}
  .muted{color:var(--muted)}
  .inp{width:100%;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:var(--panel2);color:var(--txt)}
  #log{white-space:pre-wrap;max-height:40vh;overflow:auto}
</style>
</head>
<body>
<header>
  <h1>Super User</h1>
  <div class="muted">ESP lekér • DWM lekér • Kettős beállítás • Soros log</div>
</header>

<div class="wrap grid">
  <section class="card">
    <div class="hd"><div>DWM kapcsolat</div><div id="statusPill" class="pill err">Nincs kapcsolat</div></div>
    <div class="bd">
      <div class="grid" style="grid-template-columns:160px 1fr;gap:6px 8px">
        <label>Szolgáltatás UUID</label><input class="inp" id="svcUuid" value="12345678-1234-5678-1234-1234567890ab">
        <label>CFG karakterisztika</label><input class="inp" id="cfgUuid" value="abcdef02-1234-5678-1234-1234567890ab">
        <label>DATA karakterisztika</label><input class="inp" id="dataUuid" value="abcdef01-1234-5678-1234-1234567890ab">
        <label>Req ID</label><input class="inp mono" id="reqId" value="1">
        <div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnConnect">Csatlakozás</button>
          <button class="btn ghost" id="btnOpenSerial">Soros megnyitása</button>
        </div>
        <label>ACK</label><div id="ack" class="mono muted">-</div>
      </div>
    </div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <div class="hd">
      <div>Konfiguráció</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn ghost" id="btnEspGet">LEKÉR ESP</button>
        <button class="btn ghost" id="btnDwmGet" disabled>LEKÉR DWM</button>
        <button class="btn" id="btnApply" disabled>Beállít (ESP + DWM)</button>
      </div>
    </div>
    <div class="bd">
      <table id="tblEdit">
        <thead><tr><th>Kulcs</th><th>ESP</th><th>DWM</th><th>Új érték</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="muted" style="margin-top:6px">Üres mező nem küldődik.</div>
    </div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <div class="hd"><div>Log</div><div class="muted">Soros és böngésző</div></div>
    <div class="bd mono" id="log"></div>
  </section>
</div>

<script>
/* ===== util ===== */
function $(id){ return document.getElementById(id); }
function qs(sel){ return document.querySelector(sel); }          /* ÚJ: bármilyen szelektorhoz */
function logln(s){ const L=$('log'); if(!L){console.warn(s);return;} L.textContent+=s+'\n'; L.scrollTop=L.scrollHeight; console.log(s); }
function setPill(ok,txt){ const p=$('statusPill'); if(!p) return; p.textContent=txt||(ok?'Csatlakozva':'Nincs kapcsolat'); p.className='pill '+(ok?'ok':'err'); }

/* ===== UUID getters ===== */
const UUID={ svc:()=>$('svcUuid').value.trim().toLowerCase(), cfg:()=>$('cfgUuid').value.trim().toLowerCase(), data:()=>$('dataUuid').value.trim().toLowerCase() };

/* ===== TLV map ===== */
const T={VER:0x00,STATUS:0x01,UPTIME_MS:0x02,SYNC_MS:0x03,
  NETWORK_ID:0x10,ZONE_ID:0x11,ANCHOR_ID:0x12,TX_ANT_DLY:0x13,RX_ANT_DLY:0x14,BIAS_TICKS:0x16,LOG_LEVEL:0x1F,HB_MS:0x20,
  SYN_PPM_MAX:0x30,SYN_JUMP_PPM:0x31,SYN_AB_GAP_MS:0x32,SYN_MS_EWMA_DEN:0x33,SYN_TK_EWMA_DEN:0x34,SYN_TK_MIN_MS:0x35,SYN_TK_MAX_MS:0x36,SYN_DTTX_MIN_MS:0x37,SYN_DTTX_MAX_MS:0x38,SYN_LOCK_NEED:0x39,
  PHY_CH:0x40,PHY_PLEN:0x41,PHY_PAC:0x42,PHY_TX_CODE:0x43,PHY_RX_CODE:0x44,PHY_SFD:0x45,PHY_BR:0x46,PHY_PHRMODE:0x47,PHY_PHRRATE:0x48,PHY_SFDTO:0x49,PHY_STS_MODE:0x4A,PHY_STS_LEN:0x4B,PHY_PDOA:0x4C};
const NAME=Object.fromEntries(Object.entries(T).map(([k,v])=>[v,k]));

/* ===== állapot ===== */
let g={dev:null,server:null,svc:null,cfg:null,data:null,esp:{},dwm:{}};

/* ===== táblázat ===== */
const EDIT_FIELDS=[
  ['NETWORK_ID',T.NETWORK_ID],['ZONE_ID',T.ZONE_ID],['ANCHOR_ID',T.ANCHOR_ID],
  ['HB_MS',T.HB_MS],['LOG_LEVEL',T.LOG_LEVEL],
  ['TX_ANT_DLY',T.TX_ANT_DLY],['RX_ANT_DLY',T.RX_ANT_DLY],['BIAS_TICKS',T.BIAS_TICKS],
  ['PHY_CH',T.PHY_CH],['PHY_SFDTO',T.PHY_SFDTO]
];

function renderEdit(){
  const tb = qs('#tblEdit tbody');                  /* FIX: querySelector, nem getElementById */
  if(!tb){ logln('[UI] Hiba: #tblEdit tbody nem található'); return; }
  tb.innerHTML = EDIT_FIELDS.map(([label])=>{
    const esp=(g.esp&&g.esp[label]) ?? '-';
    const dwm=(g.dwm&&g.dwm[label]) ?? '-';
    return `<tr><td>${label}</td><td class="mono">${esp}</td><td class="mono">${dwm}</td><td><input class="inp" id="in_${label}" placeholder="új érték"></td></tr>`;
  }).join('');
}

/* ===== ESP GET (HTTP) ===== */
async function doEspGet(){
  logln('[ESP] lekérés indul');
  try{
    let r = await fetch('/api/config',{cache:'no-store'});
    if(!r.ok) r = await fetch('/api/esp_config',{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP hiba, nincs válasz');
    const j = await r.json();
    g.esp = j;
    renderEdit();
    logln('[ESP] kész');
  }catch(e){
    logln('[ESP] hiba: '+e.message);
  }
}

/* ===== DWM BLE ===== */
function rd32(dv,off){return (dv.getUint8(off)<<24)|(dv.getUint8(off+1)<<16)|(dv.getUint8(off+2)<<8)|dv.getUint8(off+3);}
function onCfgNotify(ev){
  const a=new Uint8Array(ev.target.value.buffer, ev.target.value.byteOffset, ev.target.value.byteLength);
  logln('[DWM] notify len='+a.length);
  if(a.length===6 && a[0]===1 && a[1]===0x81){
    const req=(a[2]<<8)|a[3]; $('ack').textContent=`req=${req} status=0x${a[4].toString(16)} applied=${a[5]}`; return;
  }
  if(a.length===17 && a[0]===1 && a[1]===0x90) return;
  if(a.length>=3){
    let off=0, first=true, res={};
    while(off+2<=a.length){
      const t=a[off], l=a[off+1]; off+=2;
      if(off+l>a.length) break;
      const dv=new DataView(a.buffer,a.byteOffset+off,l); off+=l;
      if(first&&t===T.VER){ first=false; continue; }
      let v;
      if(l===1) v=dv.getUint8(0);
      else if(l===2) v=(dv.getUint8(0)<<8)|dv.getUint8(1);
      else if(l===4) v='0x'+rd32(dv,0).toString(16).padStart(8,'0');
      else v=`len=${l}`;
      res[NAME[t]||('T_'+t)]=v;
    }
    g.dwm={...g.dwm,...res};
    renderEdit();
  }
}

async function connect(){
  try{
    if(!('bluetooth' in navigator)){ logln('[BLE] nem támogatott'); return; }
    const device=await navigator.bluetooth.requestDevice({filters:[{services:[UUID.svc()]}],optionalServices:[UUID.svc()]});
    g.dev=device; setPill(true,'Csatlakozás…');
    const server=await device.gatt.connect();
    const svc=await server.getPrimaryService(UUID.svc());
    const cfg=await svc.getCharacteristic(UUID.cfg());
    await cfg.startNotifications();
    cfg.addEventListener('characteristicvaluechanged', onCfgNotify);
    g.server=server; g.svc=svc; g.cfg=cfg;
    setPill(true,'Csatlakozva');
    $('btnDwmGet').disabled=false;
    $('btnApply').disabled=false;
    logln('[BLE] csatlakozva');
  }catch(e){
    setPill(false,'Nincs kapcsolat'); logln('[BLE] hiba: '+e);
  }
}

function buildGet(){
  const req = Number($('reqId').value)||1;
  return new Uint8Array([1,0x02,(req>>8)&255,req&255,0]);  /* ver=1, cmd=GET */
}

async function doDwmGet(){
  if(!g.cfg){ logln('[DWM] GET kihagyva: nincs kapcsolat'); return; }
  try{
    logln('[DWM] GET küldés');
    await g.cfg.writeValueWithoutResponse(buildGet());
  }catch(e){
    logln('[DWM] GET hiba: '+e);
  }
}

/* ===== SET mindkettőnek ===== */
function gatherInputs(){
  const out={};
  for(const [label] of EDIT_FIELDS){
    const el=$('in_'+label);
    if(el&&el.value.trim()!=='') out[label]=el.value.trim();
  }
  return out;
}
function hexToU32(s){ s=String(s).trim(); if(s.startsWith('0x')||s.startsWith('0X')) return parseInt(s,16)>>>0; return (parseInt(s,10)>>>0); }
function hexToU16(s){ s=String(s).trim(); if(s.startsWith('0x')||s.startsWith('0X')) return parseInt(s,16)&0xffff; return (parseInt(s,10)&0xffff); }
function be16(x){return new Uint8Array([(x>>8)&255,x&255]);}
function be32(x){return new Uint8Array([(x>>>24)&255,(x>>>16)&255,(x>>>8)&255,x&255]);}
function pushTLV(arr,t,bytes){ arr.push(t, bytes.length, ...bytes); }

function buildSetTLV(inp){
  const tlv=[]; const num=v=>Number(v);
  if(inp.NETWORK_ID) pushTLV(tlv,T.NETWORK_ID,be16(num(inp.NETWORK_ID)&0xffff));
  if(inp.ZONE_ID){ const v=hexToU16(inp.ZONE_ID); pushTLV(tlv,T.ZONE_ID,be16(v)); }
  if(inp.ANCHOR_ID){ const v=hexToU32(inp.ANCHOR_ID); pushTLV(tlv,T.ANCHOR_ID,be32(v)); }
  if(inp.HB_MS) pushTLV(tlv,T.HB_MS,be16(Math.max(200,num(inp.HB_MS)&0xffff)));
  if(inp.LOG_LEVEL) pushTLV(tlv,T.LOG_LEVEL,new Uint8Array([num(inp.LOG_LEVEL)&0xff]));
  if(inp.TX_ANT_DLY) pushTLV(tlv,T.TX_ANT_DLY,be32(num(inp.TX_ANT_DLY)|0));
  if(inp.RX_ANT_DLY) pushTLV(tlv,T.RX_ANT_DLY,be32(num(inp.RX_ANT_DLY)|0));
  if(inp.BIAS_TICKS) pushTLV(tlv,T.BIAS_TICKS,be32(num(inp.BIAS_TICKS)|0));
  if(inp.PHY_CH) pushTLV(tlv,T.PHY_CH,new Uint8Array([num(inp.PHY_CH)&0xff]));
  if(inp.PHY_SFDTO) pushTLV(tlv,T.PHY_SFDTO,be16(num(inp.PHY_SFDTO)&0xffff));
  const req=(Number($('reqId').value)||1)+1; $('reqId').value=String(req);
  const hdr=new Uint8Array([1,0x01,(req>>8)&255,req&255,0]); /* ver=1, cmd=SET */
  return new Uint8Array([...hdr,...tlv]);
}

async function doSetBoth(){
  const inp=gatherInputs();
  if(Object.keys(inp).length===0){ logln('[SET] nincs módosítás'); return; }

  try{
    let r=await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(inp)});
    if(!r.ok) r=await fetch('/api/esp_config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(inp)});
    logln('[ESP] SET elküldve');
  }catch(e){
    logln('[ESP] SET hiba: '+e.message);
  }

  try{
    if(g.cfg){
      const pkt=buildSetTLV(inp);
      await g.cfg.writeValueWithResponse(pkt);
      logln('[DWM] SET elküldve');
    }else{
      logln('[DWM] SET kihagyva: nincs kapcsolat');
    }
  }catch(e){
    logln('[DWM] SET hiba: '+e);
  }
}

/* ===== Web Serial: soros napló olvasása ===== */
let serialReader=null;
async function openSerial(){
  if(!('serial' in navigator)){ alert('A böngésző nem támogatja a Web Serial API-t'); return; }
  try{
    const port=await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    const dec=new TextDecoderStream(); const enc=new TextEncoderStream();
    port.readable.pipeTo(dec.writable); enc.readable.pipeTo(port.writable);
    const reader=dec.readable.getReader(); serialReader=reader;
    logln('[SERIAL] megnyitva 115200');
    (async function loop(){
      for(;;){
        const {value,done}=await reader.read(); if(done) break;
        if(value) logln(value.replace(/\r?\n/g,'\n'));
      }
    })().catch(e=>logln('[SERIAL] hiba: '+e));
  }catch(e){ logln('[SERIAL] nyitási hiba: '+e); }
}

/* ===== események ===== */
$('btnConnect').addEventListener('click', connect);
$('btnDwmGet').addEventListener('click', doDwmGet);
$('btnEspGet').addEventListener('click', doEspGet);
$('btnApply').addEventListener('click', doSetBoth);
$('btnOpenSerial').addEventListener('click', openSerial);

renderEdit();   /* DOM kész, mert a script a body végén van */
</script>
</body>
</html>
